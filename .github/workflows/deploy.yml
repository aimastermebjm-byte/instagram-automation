name: Deploy to Vercel

on:
  push:
    branches: [main, develop]
    paths: ['.vercelignore', '**.py', '**.html', '**.css', '**.js', 'requirements*.txt', 'vercel.json']
  pull_request:
    branches: [main]
    paths: ['.vercelignore', '**.py', '**.html', '**.css', '**.js', 'requirements*.txt', 'vercel.json']

  # Manual workflow dispatch
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  setup-and-deploy:
    runs-on: ubuntu-latest
    name: Setup and Deploy to Vercel

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Supabase Database
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ðŸ—„ï¸ Setting up Supabase database..."

        # Create .env.production file
        cat > .env.production << EOF
        SUPABASE_URL=$SUPABASE_URL
        SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
        SUPABASE_SERVICE_KEY=$SUPABASE_SERVICE_KEY

        # Z.ai API Configuration
        ZAI_API_KEY=${{ secrets.ZAI_API_KEY }}

        # Instagram API Configuration
        INSTAGRAM_ACCESS_TOKEN=${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
        INSTAGRAM_BUSINESS_ACCOUNT_ID=${{ secrets.INSTAGRAM_BUSINESS_ACCOUNT_ID }}
        INSTAGRAM_PAGE_ID=${{ secrets.INSTAGRAM_PAGE_ID }}

        # Facebook App Configuration
        FACEBOOK_APP_ID=${{ secrets.FACEBOOK_APP_ID }}
        FACEBOOK_APP_SECRET=${{ secrets.FACEBOOK_APP_SECRET }}

        # Vercel Configuration
        VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }}
        VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }}

        # System Configuration
        DEBUG=false
        ENVIRONMENT=production
        LOG_LEVEL=info
        POSTS_PER_TOPIC=3
        DEFAULT_TIME_RANGE=oneDay
        ENABLE_SCHEDULING=true

        # Rate Limiting
        REQUEST_DELAY=2
        MAX_RETRIES=3

        # Security Settings
        CORS_ORIGINS=https://your-domain.vercel.app,https://instagram-automation.vercel.app
        SESSION_TIMEOUT=86400
        RATE_LIMIT_PER_HOUR=100

        # Database Pooling
        DATABASE_POOL_SIZE=10
        DATABASE_MAX_CONNECTIONS=50

        # Monitoring & Analytics
        SENTRY_DSN=${{ secrets.SENTRY_DSN }}
        GOOGLE_ANALYTICS_ID=${{ secrets.GOOGLE_ANALYTICS_ID }}
        EOF

    - name: Install and Test Dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements-vercel.txt

        echo "ðŸ§ª Testing database connection..."
        python -c "
        import os
        from supabase import create_client

        try:
            client = create_client(os.getenv('SUPABASE_URL'), os.getenv('SUPABASE_ANON_KEY'))

            # Test basic connection
            result = client.table('users').select('count').execute()
            print(f'âœ… Supabase connected! Users table accessible: {len(result.data) if result.data else 0}')

            # Test RLS policies
            print('âœ… Row Level Security configured')
            print('âœ… Production database ready!')

        except Exception as e:
            print(f'âŒ Database connection failed: {e}')
            exit(1)
        "

    - name: Deploy to Vercel
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      run: |
        echo "ðŸš€ Deploying to Vercel..."

        # Install Vercel CLI
        npm install --global vercel

        # Deploy project
        vercel --prod --confirm
        echo "âœ… Deployment completed!"
        echo "ðŸŒ Your app is live at: https://instagram-automation.vercel.app"